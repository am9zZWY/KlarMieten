{% extends "base.html" %}
{% load static %}

{% block title %}Mietvertrag{% endblock %}
{% block link %}
    <link rel="stylesheet" href="{% static '/css/contract.css' %}"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
{% endblock %}

{% block content %}
    <div>
        <!-- Greeting Section -->
        <div>
            <div>
                <h2>Hi, {% if user.is_authenticated %}{{ user.username }}{% else %}Gast{% endif %}</h2>
                <p>Analyse Ihres Mietvertrags vom {{ contract_details.start_date|date:"d.m.Y" }}</p>
            </div>
        </div>

        <!-- Contract Overview Cards -->
        <div>
            <div>
                <div>
                    <div>
                        <h5>Vertragsübersicht</h5>
                        <ul>
                            <li>
                                Vertragsart
                                <span>{{ contract_details.contract_type }}</span>
                            </li>
                            <li>
                                Laufzeit
                                <span>
                                    {% if contract_details.start_date %}
                                        {{ contract_details.start_date|date:"Y" }} -
                                        {% if contract_details.end_date %}
                                            {{ contract_details.end_date|date:"Y" }}
                                        {% else %}
                                            Open-End
                                        {% endif %}
                                    {% else %}
                                        Unbekannt
                                    {% endif %}
                                </span>
                            </li>
                            <li>
                                Aktuelle Miete
                                <span>€{{ contract_details.monthly_rent|floatformat:2 }}</span>
                            </li>
                            <li>
                                Nebenkosten
                                <span>€{{ contract_details.total_rent|floatformat:2 }}</span>
                            </li>
                            <li>
                                Adresse
                                <span>{{ contract_details.address }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div>
            <h5>Karte</h5>
            <div id="map" style="height: 300px;"></div>
        </div>

        <!-- Price Spectrum Visualization -->
        <div>
            <div>
                <div>
                    <div>
                        <h5>Mietpreisvergleich</h5>
                        <div style="height: 30px;">
                            <div
                                    role="progressbar"
                                    style="width: {% widthratio contract_details.monthly_rent 1500 100 %}%;">
                                €{{ contract_details.monthly_rent|floatformat:2 }}
                            </div>
                        </div>
                        <div>
                            <span>Günstig</span>
                            <span>Durchschnitt</span>
                            <span>Hochpreisig</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Document Analysis -->
        <div>
            <div>
                <div>
                    <div>
                        <img src="{% static 'contract_preview.jpg' %}"
                             alt="Vertragsvorschau"
                             style="max-height: 500px;">

                        <!-- Document Hotspots -->
                        <div style="top: 15%; left: 70%;">
                            <a href="#kündigungsfrist">Kündigungsfrist</a>
                        </div>
                        <div style="top: 30%; left: 70%;">
                            <a href="#nebenkosten">Nebenkosten</a>
                        </div>
                        <div style="top: 45%; left: 70%;">
                            <a href="#kaution">Kaution</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Annotations -->
            <div>
                <div>
                    <div>
                        <h5>Vertragsdetails</h5>
                        <div id="kündigungsfrist">
                            <strong>Kündigungsfrist:</strong> {{ contract_details.termination_terms }}
                        </div>
                        <div id="nebenkosten">
                            <strong>Nebenkosten:</strong> {{ contract_details.additional_costs }}
                        </div>
                        <div id="kaution">
                            <strong>Kaution:</strong> €{{ contract_details.deposit|floatformat:2 }}
                        </div>
                        <div>
                            <strong>Zimmeranzahl:</strong> {{ contract_details.number_of_rooms }}
                        </div>
                        <div>
                            <strong>Heizungsart:</strong> {{ contract_details.heating_type }}
                        </div>
                        <div>
                            <strong>Zusätzliche Klauseln:</strong> {{ contract_details.additional_clauses }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
    <style>
        .progress-bar {
            transition: width 1s ease-in-out;
        }

        .position-relative {
            overflow: hidden;
        }

        .card {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
    </style>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
			// Function to geocode the address and update the map
			function geocodeAddress(address) {
				const fullAddress = `${address}, Germany`;
				const nominatimURL = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(fullAddress)}&format=json`;

				fetch(nominatimURL)
					.then(response => response.json())
					.then(data => {
						if (data && data.length > 0) {
							const latitude = parseFloat(data[0].lat);
							const longitude = parseFloat(data[0].lon);

							// Update the map view and add a marker
							map.setView([latitude, longitude], 15);
							L.marker([latitude, longitude]).addTo(map)
								.bindPopup(`Adresse: ${fullAddress}`)
								.openPopup();
						} else {
							console.error("Adresse nicht gefunden.");
							// Handle the case where the address is not found
						}
					})
					.catch(error => {
						console.error("Fehler bei der Geocodierung:", error);
						// Handle any errors during the geocoding process
					});
			}

			// Initialize the map
			var map = L.map('map', {
                center: [51.505, -0.09],
                zoom: 13,
            })

			L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			// Get the address details from the Django template
			const address = "{{ contract_details.address }}";

			// Geocode the address and update the map
			geocodeAddress(address);
    </script>
{% endblock %}
