{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="contract-censor">
    <h2>Censor Sensitive Information</h2>
    <p>Select a contract page below, then use the drawing tools to black out any sensitive information.</p>
    
    <div class="contract-thumbnails">
        <h3>Contract Pages</h3>
        <div class="thumbnail-grid">
            {% for file in contract.files.all %}
                <div class="thumbnail-item {% if forloop.first %}active{% endif %}" data-file-id="{{ file.id }}">
                    <img src="{% url 'contract_file' contract.id file.file_name %}" alt="Contract page {{ forloop.counter }}">
                    <div class="thumbnail-status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Original</span>
                    </div>
                </div>
            {% empty %}
                <p>No contract files found. Please upload files first.</p>
            {% endfor %}
        </div>
    </div>
    
    <div class="drawing-tools">
        <div class="drawing-controls">
            <button id="pen-tool" class="button highlight active">
                <i class="fas fa-pen"></i> Pen
            </button>
            <button id="eraser-tool" class="button highlight">
                <i class="fas fa-eraser"></i> Eraser
            </button>
            <button id="reset-tool" class="button highlight">
                <i class="fas fa-undo"></i> Reset
            </button>
            
            <div class="size-control">
                <label for="brush-size">Brush Size:</label>
                <input type="range" id="brush-size" min="5" max="50" value="20">
                <span id="size-value">20px</span>
            </div>
        </div>
        
        <div class="canvas-container">
            <canvas id="drawing-canvas"></canvas>
            <div class="canvas-placeholder">Select a contract page to edit</div>
        </div>
        
        <div class="action-buttons">
            <button id="save-current" class="button">Save Current Page</button>
            <button id="save-all" class="button">Save All & Continue</button>
        </div>
    </div>
</section>

<style>
    .contract-censor {
        margin-bottom: 2rem;
    }
    
    .contract-thumbnails {
        margin-bottom: 1.5rem;
    }
    
    .thumbnail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .thumbnail-item {
        border: 2px solid #ccc;
        border-radius: 4px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .thumbnail-item.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px var(--primary);
    }
    
    .thumbnail-item img {
        width: 100%;
        height: 150px;
        object-fit: contain;
        background: #f5f5f5;
    }
    
    .thumbnail-status {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 0.75rem;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
    }
    
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ccc;
        margin-right: 0.5rem;
    }
    
    .thumbnail-item.censored .status-indicator {
        background: var(--primary);
    }
    
    .drawing-tools {
        background: var(--section-bg);
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 1rem;
    }
    
    .drawing-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: center;
    }
    
    .size-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
    }
    
    .canvas-container {
        border: 2px solid var(--text);
        margin: 1rem 0;
        overflow: auto;
        max-height: 70vh;
        background: #f5f5f5;
        position: relative;
        min-height: 300px;
    }
    
    .canvas-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #666;
    }
    
    canvas {
        display: block;
        cursor: crosshair;
    }
    
    .action-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
    }
    
    @media (max-width: 768px) {
        .drawing-controls {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .size-control {
            margin-left: 0;
            width: 100%;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 1rem;
        }
        
        .thumbnail-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const penTool = document.getElementById('pen-tool');
        const eraserTool = document.getElementById('eraser-tool');
        const resetTool = document.getElementById('reset-tool');
        const brushSize = document.getElementById('brush-size');
        const sizeValue = document.getElementById('size-value');
        const saveCurrentBtn = document.getElementById('save-current');
        const saveAllBtn = document.getElementById('save-all');
        const thumbnailItems = document.querySelectorAll('.thumbnail-item');
        const canvasPlaceholder = document.querySelector('.canvas-placeholder');
        
        // Drawing state
        let isDrawing = false;
        let currentTool = 'pen';
        let currentSize = brushSize.value;
        let currentFileId = null;
        let originalImageData = null;
        let modifiedFiles = new Set();
        
        // Update size display
        sizeValue.textContent = `${currentSize}px`;
        
        // Initialize with the first file if available
        if (thumbnailItems.length > 0) {
            const firstItem = thumbnailItems[0];
            currentFileId = firstItem.dataset.fileId;
            loadImage(firstItem.querySelector('img').src);
            canvasPlaceholder.style.display = 'none';
        }
        
        // Load image into canvas
        function loadImage(src) {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.src = src;
            
            img.onload = function() {
                // Resize canvas to match image dimensions
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw image on canvas
                ctx.drawImage(img, 0, 0);
                
                // Store original image data for reset
                originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            };
        }
        
        // Thumbnail click handler
        thumbnailItems.forEach(item => {
            item.addEventListener('click', function() {
                // Save current canvas if modified
                if (currentFileId && modifiedFiles.has(currentFileId)) {
                    saveCurrentCanvas();
                }
                
                // Update active thumbnail
                thumbnailItems.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Load selected image
                currentFileId = this.dataset.fileId;
                loadImage(this.querySelector('img').src);
                canvasPlaceholder.style.display = 'none';
            });
        });
        
        // Tool selection
        penTool.addEventListener('click', function() {
            currentTool = 'pen';
            updateToolButtons(penTool);
        });
        
        eraserTool.addEventListener('click', function() {
            currentTool = 'eraser';
            updateToolButtons(eraserTool);
        });
        
        resetTool.addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all censoring on this page?')) {
                if (originalImageData) {
                    ctx.putImageData(originalImageData, 0, 0);
                    
                    // If this file was marked as modified, update its status
                    if (modifiedFiles.has(currentFileId)) {
                        modifiedFiles.delete(currentFileId);
                        updateThumbnailStatus(currentFileId, false);
                    }
                }
            }
        });
        
        // Update active tool button
        function updateToolButtons(activeButton) {
            [penTool, eraserTool].forEach(btn => {
                btn.classList.remove('active');
            });
            activeButton.classList.add('active');
        }
        
        // Brush size slider
        brushSize.addEventListener('input', function() {
            currentSize = this.value;
            sizeValue.textContent = `${currentSize}px`;
        });
        
        // Drawing functionality
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('touchstart', handleTouchStart);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', handleTouchMove);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineWidth = currentSize;
            ctx.lineCap = 'round';
            
            if (currentTool === 'pen') {
                ctx.strokeStyle = '#000000';
                ctx.globalCompositeOperation = 'source-over';
            } else {
                // Eraser - reveal the original image
                ctx.strokeStyle = 'rgba(0, 0, 0, 0)';
                ctx.globalCompositeOperation = 'destination-out';
            }
            
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // Mark this file as modified
            if (currentFileId && !modifiedFiles.has(currentFileId)) {
                modifiedFiles.add(currentFileId);
                updateThumbnailStatus(currentFileId, true);
            }
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        // Update thumbnail status
        function updateThumbnailStatus(fileId, isCensored) {
            const thumbnail = document.querySelector(`.thumbnail-item[data-file-id="${fileId}"]`);
            if (thumbnail) {
                if (isCensored) {
                    thumbnail.classList.add('censored');
                    thumbnail.querySelector('.status-text').textContent = 'Censored';
                } else {
                    thumbnail.classList.remove('censored');
                    thumbnail.querySelector('.status-text').textContent = 'Original';
                }
            }
        }
        
        // Save current canvas
        function saveCurrentCanvas() {
            if (!currentFileId) return;
            
            const censoredImageData = canvas.toDataURL('image/png');
            
            // Find the thumbnail for this file
            const thumbnail = document.querySelector(`.thumbnail-item[data-file-id="${currentFileId}"]`);
            if (thumbnail) {
                // Update the thumbnail image with the censored version
                thumbnail.querySelector('img').src = censoredImageData;
                updateThumbnailStatus(currentFileId, true);
            }
            
            // Send the censored image to the server
            const formData = new FormData();
            formData.append('file_id', currentFileId);
            formData.append('censored_image', censoredImageData);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            fetch('{% url "save_edited_contract" contract.id %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Successfully saved censored image for file ${currentFileId}`);
                } else {
                    alert('Error saving censored image. Please try again.');
                    console.error(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving. Please try again.');
            });
        }
        
        // Save current button
        saveCurrentBtn.addEventListener('click', function() {
            if (currentFileId) {
                saveCurrentCanvas();
            } else {
                alert('Please select a contract page first.');
            }
        });
        
        // Save all and continue
        saveAllBtn.addEventListener('click', function() {
            // Save current canvas if modified
            if (currentFileId && modifiedFiles.has(currentFileId)) {
                saveCurrentCanvas();
            }
            
            // Redirect to next step
            window.location.href = "{% url 'analyze_contract' contract.id %}";
        });
    });
</script>
{% endblock %}