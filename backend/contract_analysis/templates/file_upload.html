{% load static %}

<div class="upload-area {% if form.errors %}has-error{% endif %}"
     aria-label="Datei-Upload-Bereich"
     data-max-size="{{ max_file_size }}"
     data-accepted-types="{{ accepted_file_types|join:',' }}"
>
    <input
            accept="{{ accepted_file_types|join:',' }}"
            hidden
            id="fileInput"
            multiple
            type="file"
    />
    <div class="upload-content">
        <ul class="file-preview" id="file-preview"></ul>
        <span class="upload-instructions">
            Ziehen Sie Ihren Mietvertrag
            hierher oder
        </span>
        <label for="fileInput" class="file-label">
            Dateien auswählen
        </label>
    </div>
</div>

{% if form.errors %}
    <div class="error-message" role="alert">
        {{ form.errors }}
    </div>
{% endif %}

<form method="POST"
      enctype="multipart/form-data"
      class="upload-form"
      data-upload-url="{% url 'upload_files' %}"
>
    {% csrf_token %}
    <button type="submit" class="btn btn-primary btn-large" disabled>
        Hochladen
    </button>
</form>

<script>
	const config = {
		maxFileSize: {{ max_file_size|default:"10485760" }},  // 10MB default
		acceptedTypes: {{ accepted_file_types|safe|default:"['application/pdf', 'image/jpeg', 'image/png']" }},
		urls: {
			upload: "{% url 'upload_files' %}"
		},
		csrf: "{{ csrf_token }}"
	};

	class FileUploadHandler {
		constructor(config) {
			this.files = new Set();
			this.initElements();
			this.bindEvents();
		}

		initElements() {
			this.elements = {
				uploadArea: document.querySelector('.upload-area'),
				fileInput: document.querySelector('input[type="file"]'),
				preview: document.querySelector('.file-preview'),
				errorMessage: document.querySelector('.error-message'),
				uploadButton: document.querySelector('button[type="submit"]'),
			};
		}

		bindEvents() {
			this.elements.uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
			this.elements.uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
			this.elements.uploadArea.addEventListener('drop', this.handleDrop.bind(this));
			this.elements.fileInput.addEventListener('change', this.handleFileInput.bind(this));
			document.querySelector('form').addEventListener('submit', this.handleSubmit.bind(this));
		}

		handleDragOver(event) {
			event.preventDefault();
			this.elements.uploadArea.classList.add('dragging');
		}

		handleDragLeave(event) {
			event.preventDefault();
			this.elements.uploadArea.classList.remove('dragging');
		}

		handleDrop(event) {
			event.preventDefault();
			this.elements.uploadArea.classList.remove('dragging');
			this.handleFiles(event.dataTransfer.files);
		}

		handleFileInput(event) {
			this.handleFiles(event.target.files);
		}


		// Validate file
		validateFile(file) {
			if (!config.acceptedTypes.includes(file.type)) {
				return "Nur PDF, JPEG und PNG Dateien sind erlaubt.";
			}
			if (file.size > config.maxFileSize) {
				return "Die Datei darf nicht größer als 10MB sein.";
			}
			return null;
		}

		showError(message) {
			this.elements.errorMessage.textContent = message;
			this.elements.errorMessage.style.display = "block";
		}

		// Handle files
		handleFiles(fileList) {
			for (let i = 0; i < fileList.length; i++) {
				const file = fileList[i];
				const error = this.validateFile(file);
				if (error) {
					return this.showError(error);
				}
				this.files.add(file);
				const listItem = document.createElement("li");
				listItem.className = "file";
				listItem.innerHTML = `
                ${
					file.type.startsWith("image/")
						? `<img src="${URL.createObjectURL(
							file
						)}" alt="File Preview"/>`
						: `<span>${file.name}</span>`
				}
                <button type="button" class="remove" onclick="uploader.removeFile('${
					file.name
				}')">Entfernen</button>
            `;
				this.elements.preview.appendChild(listItem);
			}
			this.updateUI();
		}

		// Remove a file
		removeFile(fileName) {
			this.files = new Set([...this.files].filter((file) => file.name !== fileName));
			const items = document.querySelectorAll(".file");
			items.forEach((item) => {
				if (item.textContent.includes(fileName)) {
					item.remove();
				}
			});
			this.updateUI();
		}

		// Update UI
		updateUI() {
			this.elements.uploadButton.disabled = this.files.size === 0;
			this.elements.errorMessage.style.display = "none";
		}

		// Drag and drop events

		// Form submission
		handleSubmit() {
			if (this.files.size === 0) {
				return this.showError("Bitte wählen Sie mindestens eine Datei aus.");
			}
			const formData = new FormData();
			this.files.forEach((file) => formData.append("files", file));
			fetch('{% url "upload_files" %}', {
				method: "POST",
				body: formData,
				headers: {
					"X-CSRFToken": "{{ csrf_token }}",
				},
			})
				.then((response) => response.json())
				.then((data) => {
					if (data.success) {
						alert("Dateien erfolgreich hochgeladen!");
						this.files.clear();
						this.elements.preview.innerHTML = "";
						this.updateUI();
					} else {
						this.showError("Fehler beim Hochladen.");
					}
				})
				.catch((error) => {
					console.error("Upload error:", error);
					this.showError("Fehler beim Hochladen.");
				});
		}
	}

	const uploader = new FileUploadHandler(config);
</script>

<style>
    input {
        flex: 1;
        padding: 1rem;
        border: none;
    }

    button.remove {
        background: #ff3333;
        color: white;
    }

    .upload-area {
        --border-color: rgba(255, 255, 255, 0.3);
        --hover-bg: rgba(255, 255, 255, 0.2);

        background: rgba(255, 255, 255, 0.1);
        border: 2px dashed var(--border-color);
        padding: 2rem;
        text-align: center;
        margin-block-end: 2rem;
        transition: all 0.3s ease;

        &.dragging {
            background: var(--hover-bg);
            border-color: var(--primary);
        }

        &.has-error {
            border-color: var(--error);
        }
    }

    .upload-area.dragging {
        background: rgba(255, 255, 255, 0.2);
        border-color: var(--primary);
    }

    .upload-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .upload-content label {
        color: var(--primary);
        cursor: pointer;
        text-decoration: underline;
    }

    .upload-content label:hover {
        color: var(--primary-light);
    }

    .error-message {
        background: rgba(255, 0, 0, 0.1);
        color: #ff3333;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .upload-area.has-error {
        border-color: #ff3333;
    }

    .file-preview {
        display: flex;
        align-items: flex-start;
        flex-direction: column;
        gap: 1rem;
    }

    .file {
        display: flex;
        gap: 1rem;
    }

    .file-preview img {
        max-width: 100px;
        max-height: 100px;
        object-fit: contain;
    }
</style>
