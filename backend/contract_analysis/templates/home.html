{% extends 'base.html' %}

{% block title %}
    Mietverträge
{% endblock %}

{% block content %}
    {% if not user.is_authenticated %}
        <div class="login-container">
            <p>Bitte melden Sie sich an, um Ihre Mietverträge zu verwalten</p>
            <a href="{% url 'login' %}">Anmelden</a>
        </div>
    {% else %}
        <!-- Greeting Section -->
        <div>
            <div>
                <h2>Hi, {{ user.username }}</h2>
                <p>Verwalten Sie Ihre Mietverträge</p>
            </div>
        </div>
        <section class="contracts-section">

            <!-- Add Contract -->
            {% include 'file_upload.html' %}

            <!-- Search and Filter -->
            <div class="table-controls">
                <input
                        type="text"
                        id="contractSearch"
                        placeholder="Verträge durchsuchen..."
                        class="search-input"
                >
            </div>

            <!-- Contracts Table -->
            {% if contracts %}
                <div class="table-responsive">
                    <table class="contracts-table">
                        <thead>
                        <tr>
                            <th>Nummer</th>
                            <th>Dokumente</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for contract in contracts %}
                            <tr data-contract-id="{{ contract.id }}">
                                <td>
                                    <strong>Mietvertrag {{ forloop.counter }}</strong>
                                </td>
                                <td>
                                    {% for file in contract.files.all %}
                                        <a
                                                href="{{ file.contract_file }}"
                                                target="_blank"
                                                class="file-link"
                                        >
                                            {{ file.file.name }}
                                        </a>
                                    {% endfor %}
                                </td>
                                <td>
                    <span class="status-badge
                      {% if contract.status == 'analyzed' %}status-success
                      {% elif contract.status == 'pending' %}status-warning
                      {% else %}status-default{% endif %}">
                      {{ contract.status }}
                    </span>
                                </td>
                                <td class="action-column">
                                    <a
                                            data-contract-id="{{ contract.id }}"
                                            href="{% url 'contract' %}?id={{ contract.id }}"
                                            class="button small {% if contract.status != 'analyzed' %}hide{% endif %}"
                                    >
                                        Details anzeigen
                                    </a>
                                    <button
                                            data-contract-id="{{ contract.id }}"
                                            onclick="analyzeContract('{{ contract.id }}')"
                                            class="small"
                                            {% if contract.status == 'processing' %}disabled{% endif %}
                                    >
                                        Analyse starten
                                    </button>
                                    <button
                                            onclick="archiveContract('{{ contract.id }}')"
                                            class="small bg-error"
                                    >
                                        Archivieren
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="no-contracts">
                    <p>Keine Verträge vorhanden</p>
                </div>
            {% endif %}
        </section>

        {% block extra_js %}
            <script>
							// Enhanced search functionality
							document.getElementById('contractSearch').addEventListener('input', function (e) {
								const searchText = e.target.value.toLowerCase()
								const rows = document.querySelectorAll('.contracts-table tbody tr')

								rows.forEach((row) => {
									const text = row.textContent.toLowerCase()
									row.style.display = text.includes(searchText) ? '' : 'none'
								})
							})

							function updateStatus(id, status) {
								const row = document.querySelector(`tr[data-contract-id="${id}"]`)
								const button = row.querySelector(`button[data-contract-id="${id}"]`)
								const link = row.querySelector(`a[data-contract-id="${id}"]`)

								if (row) {
									const statusCell = row.querySelector('.status-badge')
									if (statusCell) {
										statusCell.textContent = status
										statusCell.className = `status-badge
                                          ${status === 'analyzed' ? 'status-success'
											: status === 'pending' ? 'status-warning'
												: 'status-default'}`
									}
								}

								if (button) {
									button.disabled = status === 'processing'
								}

								if (link) {
									link.classList.toggle('hide', status !== 'analyzed')
								}
							}

							function analyzeContract(id) {
								// Send a request to start the analysis
								// Disable the button to prevent multiple clicks
								const button = document.querySelector(`button[data-contract-id="${id}"]`)
								if (button) {
									button.disabled = true
								}
								updateStatus(id, 'processing')

								fetch(`/analyze_contract?contract_id=${id}`, {
									method: 'GET',
									headers: {
										'X-CSRFToken': '{{ csrf_token }}'
									}
								})
							}

							function archiveContract(id) {
								fetch(`/archive_contract?contract_id=${id}`, {
									method: 'GET',
									headers: {
										'X-CSRFToken': '{{ csrf_token }}'
									}
								}).then(() => {
									const row = document.querySelector(`tr[data-contract-id="${id}"]`)
									if (row) {
										row.remove()
									}
								})
							}

							// Handle SSE
							const contractIds = [{% for contract in contracts %}"{{ contract.id }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
							for (const id of contractIds) {
								const source = new EventSource('/analyze_contract_update?contract_id=' + id);

								source.onmessage = function (event) {
									updateStatus(id, event.data);
								};

								source.onerror = function (error) {
									console.error("SSE connection error:", error);
									source.close(); // Close the connection on error
								};
							}

            </script>
        {% endblock %}
    {% endif %}
{% endblock %}

{% block extra_css %}
    <style>
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        .contracts-table {
            width: 100%;
            border-collapse: collapse;
        }

        .contracts-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid;
        }

        .contracts-table td {
            padding: 12px;
            border-bottom: 1px solid;
        }

        .status-badge {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .status-success {
            background-color: #e7f5e7;
            color: #2c7f2e;
        }

        .status-warning {
            background-color: #fff4e6;
            color: #d46b08;
        }

        .status-default {
            background-color: #f5f5f5;
            color: #666;
        }

        .action-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .table-controls {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }
    </style>
{% endblock %}
