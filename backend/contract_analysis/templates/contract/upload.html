{% load static %}

<div class="container mt-4" x-data="fileUpload()" x-init="init()">

    <!-- Upload Area -->
    <div class="text-center d-flex flex-column align-items-center border rounded p-4 mb-4 bg-transparent"
         x-on:dragover.prevent="handleDragOver"
         x-on:dragleave.prevent="handleDragLeave"
         x-on:drop.prevent="handleDrop"
         :class="{ 'dragging': isDragging, 'has-error': hasError }"
         aria-label="Datei-Upload-Bereich"
         :data-max-size="maxFileSize"
         :data-accepted-types="acceptedTypes.join(',')"
    >
        <input
                accept="{{ accepted_file_types|join:',' }}"
                hidden
                id="fileInput"
                multiple
                type="file"
                @change="handleFileInput"
        />
        <div class="upload-icon mb-2">
            <ul class="file-preview list-group mb-3" id="file-preview" x-ref="preview"></ul>
            <p class="upload-instructions mb-2">
                Ziehen Sie Ihren Mietvertrag hierher oder
            </p>
            <label for="fileInput" class="btn btn-primary">
                WÃ¤hlen Sie Dateien aus
            </label>
        </div>
    </div>

    <!-- Error Message -->
    <div class="error-message alert alert-danger" role="alert" x-show="hasError" x-text="errorMessage"></div>

    <!-- Upload Form -->
    <form method="POST"
          enctype="multipart/form-data"
          class="upload-form"
          hx-post="{% url 'upload_contract' %}"
          hx-target="#file-preview"
          hx-swap="outerHTML"
          @submit.prevent="handleSubmit"
    >
        {% csrf_token %}
        <button type="submit" class="btn btn-primary btn-lg" :disabled="uploadStatus !== 'idle'">
            Hochladen
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"
                  x-show="uploadStatus === 'uploading'"></span>
        </button>
    </form>

</div>

<script>
	function fileUpload() {
		return {
			files: [],
			maxFileSize: {{ max_file_size|default:'10485760' }},
			acceptedTypes: {{ accepted_file_types|safe|default:"['application/pdf', 'image/jpeg', 'image/png']" }},
			csrf: '{{ csrf_token }}',
			uploadStatus: 'idle',
			isDragging: false,
			hasError: false,
			errorMessage: '',

			init() {
				this.updateUI();
			},

			handleDragOver(event) {
				this.isDragging = true;
			},

			handleDragLeave(event) {
				this.isDragging = false;
			},

			handleDrop(event) {
				this.isDragging = false;
				this.handleFiles(event.dataTransfer.files);
			},

			handleFileInput(event) {
				this.handleFiles(event.target.files);
			},

			handleFiles(fileList) {
				for (const file of fileList) {
					if (!this.validateFile(file)) {
						return;
					}
					this.files.push(file);
					this.createPreview(file);
				}
				this.updateUI();
			},

			validateFile(file) {
				if (!this.acceptedTypes.includes(file.type)) {
					this.showError(`UngÃ¼ltiger Dateityp (${file.type || 'unbekannt'}). Erlaubt: ${this.acceptedTypes.join(', ')}`);
					return false;
				}
				if (file.size > this.maxFileSize) {
					this.showError('Die Datei darf nicht grÃ¶ÃŸer als 10MB sein.');
					return false;
				}
				return true;
			},

			showError(message) {
				this.errorMessage = message;
				this.hasError = true;
			},

			resetError() {
				this.errorMessage = '';
				this.hasError = false;
			},

			createPreview(file) {
				const listItem = document.createElement('li');
				listItem.dataset.filename = file.name;

				if (file.type.startsWith('image/')) {
					const imgLink = document.createElement('a');
					imgLink.href = URL.createObjectURL(file);
					imgLink.target = '_blank';
					const imgPreview = document.createElement('img');
					imgPreview.src = URL.createObjectURL(file);
					imgLink.appendChild(imgPreview);
					listItem.appendChild(imgLink);
				} else if (file.type === 'application/pdf') {
					const pdfPreview = document.createElement('div');
					const pdfLink = document.createElement('a');
					pdfLink.href = URL.createObjectURL(file);
					pdfLink.textContent = 'ðŸ“„ ' + file.name;
					pdfLink.target = '_blank';
					pdfPreview.appendChild(pdfLink);
					pdfPreview.className = 'pdf-preview';
					listItem.prepend(pdfPreview);
				}

				listItem.className = 'file list-group-item d-flex justify-content-between align-items-center';
				listItem.innerHTML += `
                    <button type="button" class="btn btn-danger btn-sm" @click="removeFile('${file.name}')">Entfernen</button>
                `;
				this.$refs.preview.appendChild(listItem);
			},

			removeFile(fileName) {
				this.files = this.files.filter(file => file.name !== fileName);
				document.querySelector(`li[data-filename="${fileName}"]`).remove();
				this.updateUI();
			},

			updateUI() {
				if (this.files.length === 0) {
					this.uploadStatus = 'disabled';
				} else {
					this.uploadStatus = 'idle';
				}
				this.resetError();
			},

			handleSubmit() {
				if (this.files.length === 0) {
					return this.showError('Bitte wÃ¤hlen Sie mindestens eine Datei aus.');
				}
				this.uploadStatus = 'uploading';
			}
		}
	}
</script>
