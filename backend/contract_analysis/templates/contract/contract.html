{% extends "base.html" %}
{% load static %}

{% block title %}Mietvertrag{% endblock %}
{% block link %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
{% endblock %}

{% block content %}
    {% if not user.is_authenticated %}
        <div class="login-section">
            <div class="login-container">
                <h2>Anmeldung erforderlich</h2>
                <p>Bitte melden Sie sich an, um Ihre Mietverträge zu verwalten</p>
                <a href="{% url 'login' %}" class="button">Anmelden</a>
            </div>
        </div>
    {% else %}
        <div class="fade-in">
            <!-- Greeting Section -->
            <div class="dashboard-header">
                <div class="user-greeting">
                    <h2>Hi, {{ user.username }}</h2>
                    <p>Analyse Ihres Mietvertrags vom {{ contract_details.start_date|date:"d.m.Y" }}</p>
                </div>
                <div class="quick-actions">
                    <a href="{% url 'home' %}" class="button outline">Zurück zur Übersicht</a>
                </div>
            </div>

            <!-- Contract Overview Cards -->
            <section class="slide-in">
                <div class="section-header">
                    <h3>Vertragsübersicht</h3>
                </div>
                <div class="card">
                    <div class="card-body">
                        <ul class="w-full" style="list-style: none; padding: 0;">
                            <li class="flex justify-between items-center mb-sm">
                                <span class="text-light">Vertragsart</span>
                                <span class="font-weight-bold">{{ contract_details.contract_type }}</span>
                            </li>
                            <li class="flex justify-between items-center mb-sm">
                                <span class="text-light">Laufzeit</span>
                                <span class="font-weight-bold">
                                    {% if contract_details.start_date %}
                                        {{ contract_details.start_date|date:"Y" }} -
                                        {% if contract_details.end_date %}
                                            {{ contract_details.end_date|date:"Y" }}
                                        {% else %}
                                            Unbefristet
                                        {% endif %}
                                    {% else %}
                                        Unbekannt
                                    {% endif %}
                                </span>
                            </li>
                            <li class="flex justify-between items-center mb-sm">
                                <span class="text-light">Aktuelle Miete</span>
                                <span class="font-weight-bold">{{ contract_details.monthly_rent|floatformat:2 }}€</span>
                            </li>
                            <li class="flex justify-between items-center mb-sm">
                                <span class="text-light">Nebenkosten</span>
                                <span class="font-weight-bold">{{ contract_details.total_rent|floatformat:2 }}€</span>
                            </li>
                            <li class="flex justify-between items-center">
                                <span class="text-light">Wohnfläche</span>
                                <span class="font-weight-bold flex items-center">
                                    {{ contract_details.living_space|floatformat:2 }} m<sup>2</sup>
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Map -->
            <section class="slide-in">
                <div class="section-header">
                    <h3>Standort</h3>
                    <div class="text-sm text-light">{{ contract_details.address }}</div>
                </div>
                <div id="map" style="height: 300px; border-radius: var(--border-radius);"></div>
            </section>

            <!-- Price Spectrum Visualization -->
            <section class="slide-in">
                <div class="section-header">
                    <h3>Mietpreisvergleich</h3>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="progress-bar mt-md mb-md">
                            <div class="progress-bar-fill"
                                 role="progressbar"
                                 style="width: {% widthratio contract_details.monthly_rent 1500 100 %}%;">
                            </div>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-success">Günstig</span>
                            <span>Durchschnitt</span>
                            <span class="text-warning">Hochpreisig</span>
                        </div>
                        <div class="text-center mt-md">
                            <span class="status-badge {% if contract_details.monthly_rent < 800 %}status-success{% elif contract_details.monthly_rent > 1200 %}status-warning{% else %}status-default{% endif %}">
                                €{{ contract_details.monthly_rent|floatformat:2 }}
                            </span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- LLM Chatbot -->
            <section class="slide-in">
                <div class="section-header">
                    <h3>Chatbot</h3>
                </div>
                <div class="card">
                    <div class="chat-container">
                        <!-- Cards with FAQs -->
                        <h4>Vorgeschlagene Fragen</h4>
                        <div class="faq-card-container">
                            <div class="faq-card">
                                Wann sollte ich meinen Mietvertrag kündigen?
                            </div>
                            <div class="faq-card">
                                Wie hoch darf die Miete erhöht werden?
                            </div>
                            <div class="faq-card">
                                Was sind die typischen Nebenkosten?
                            </div>
                        </div>

                        <form class="chat-form">
                            <input type="text" placeholder="Frage eingeben" class="chat-input">
                            <button type="submit" class="chat-submit">Senden</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Contract Document Analysis -->
            <div class="grid grid-2 gap-lg mt-lg">
                <section class="slide-in">
                    <div class="section-header">
                        <h3>Vertragsdokument</h3>
                    </div>
                    <div class="card" style="position: relative;">
                        {% for file in contract.files.all %}
                            <div class="file-preview" data-file-id="{{ file.id }}">
                                <img src="{% url 'contract_file' contract.id file.id %}"
                                     alt="Vertragsseite {{ forloop.counter }}">
                            </div>
                        {% endfor %}

                        <!-- Document Hotspots -->
                        <div class="tooltip" style="position: absolute; top: 15%; left: 70%;">
                            <span class="badge">1</span>
                            <span class="tooltip-text">Kündigungsfrist</span>
                        </div>
                        <div class="tooltip" style="position: absolute; top: 30%; left: 70%;">
                            <span class="badge">2</span>
                            <span class="tooltip-text">Nebenkosten</span>
                        </div>
                        <div class="tooltip" style="position: absolute; top: 45%; left: 70%;">
                            <span class="badge">3</span>
                            <span class="tooltip-text">Kaution</span>
                        </div>
                    </div>
                </section>

                <!-- Document Annotations -->
                <section class="slide-in">
                    <div class="section-header">
                        <h3>Vertragsdetails</h3>
                    </div>
                    <div class="card">
                        <div class="accordion active" id="kündigungsfrist">
                            <div class="accordion-header">
                                <span>Kündigungsfrist</span>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content" style="display: block;">
                                {{ contract_details.termination_terms }}
                            </div>
                        </div>

                        <div class="accordion" id="nebenkosten">
                            <div class="accordion-header">
                                <span>Nebenkosten</span>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                {{ contract_details.additional_costs }}
                            </div>
                        </div>

                        <div class="accordion" id="kaution">
                            <div class="accordion-header">
                                <span>Kaution</span>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                €{{ contract_details.deposit|floatformat:2 }}
                            </div>
                        </div>

                        <div class="accordion">
                            <div class="accordion-header">
                                <span>Zimmeranzahl</span>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                {{ contract_details.number_of_rooms }}
                            </div>
                        </div>

                        <div class="accordion">
                            <div class="accordion-header">
                                <span>Heizungsart</span>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                {{ contract_details.heating_type }}
                            </div>
                        </div>

                        <div class="accordion">
                            <div class="accordion-header">
                                <span>Zusätzliche Klauseln</span>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                {{ contract_details.additional_clauses }}
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
			// Function to geocode the address and update the map
			function geocodeAddress(address) {
				const fullAddress = `${address}, Germany`;
				const nominatimURL = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(fullAddress)}&format=json`;

				fetch(nominatimURL)
					.then(response => response.json())
					.then(data => {
						if (data && data.length > 0) {
							const latitude = parseFloat(data[0].lat);
							const longitude = parseFloat(data[0].lon);

							// Update the map view and add a marker
							map.setView([latitude, longitude], 15);
							L.marker([latitude, longitude]).addTo(map)
								.bindPopup(`Adresse: ${fullAddress}`)
								.openPopup();
						} else {
							console.error("Adresse nicht gefunden.");
							// Handle the case where the address is not found
						}
					})
					.catch(error => {
						console.error("Fehler bei der Geocodierung:", error);
						// Handle any errors during the geocoding process
					});
			}

			// Initialize the map
			var map = L.map('map', {
				center: [51.505, -0.09],
				zoom: 13,
			})

			L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			// Get the address details from the Django template
			const address = "{{ contract_details.address }}";

			// Geocode the address and update the map
			geocodeAddress(address);
    </script>
{% endblock %}
