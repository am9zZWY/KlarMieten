{% extends 'base.html' %}

{% block title %}
    Darf Vermieter Das? - Mietverträge
{% endblock %}

{% block content %}
    {% if not user.is_authenticated %}
        <section class="login-section">
            <div class="login-container">
                <h2>Willkommen bei Darf Vermieter Das?</h2>
                <p>Bitte melden Sie sich an, um Ihre Mietverträge zu analysieren und zu verwalten.</p>
                <a href="{% url 'login' %}" class="button highlight active larger">Anmelden</a>
            </div>
        </section>
    {% else %}
        <!-- Dashboard Header -->
        <section class="dashboard-header">
            <div class="user-greeting">
                <h2>Willkommen zurück, {{ user.username }}!</h2>
                <p>Hier können Sie Ihre Mietverträge hochladen, analysieren und verwalten.</p>
            </div>
            <div class="quick-actions">
                <button id="showUploadForm" class="highlight active">Neuen Vertrag hochladen</button>
            </div>
        </section>

        <!-- Upload Contract Section (Initially Hidden) -->
        <section id="uploadContractSection" class="upload-section hide">
            {% include 'contract/upload.html' %}
        </section>

        <!-- Contracts Management Section -->
        <section class="contracts-section">
            <div class="section-header">
                <h3>Meine Mietverträge</h3>

                <!-- Search and Filter -->
                <div class="table-controls">
                    <input
                            type="text"
                            id="contractSearch"
                            placeholder="Verträge durchsuchen..."
                            class="search-input"
                    >
                </div>
            </div>

            <!-- Contracts Table -->
            {% if contracts %}
                <div class="table-responsive">
                    <table class="contracts-table">
                        <thead>
                        <tr>
                            <th>Vertrag</th>
                            <th>Dokumente</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for contract in contracts %}
                            <tr data-contract-id="{{ contract.id }}">
                                <td>
                                    <strong>Mietvertrag {{ forloop.counter }}</strong>
                                </td>
                                <td class="documents-cell">
                                    <div class="documents-container">
                                        {% for file in contract.files.all %}
                                            <div class="thumbnail-item" data-file-id="{{ file.id }}">
                                                <img src="{% url 'contract_file' contract.id file.id %}"
                                                     alt="Vertragsseite {{ forloop.counter }}">
                                            </div>
                                        {% empty %}
                                            <p>Keine Vertragsdateien gefunden. Bitte laden Sie zuerst Dateien hoch.</p>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge
                                      {% if contract.status == 'analyzed' %}status-success
                                      {% elif contract.status == 'pending' %}status-warning
                                      {% else %}status-default{% endif %}">
                                      {{ contract.status }}
                                    </span>
                                </td>
                                <td class="action-column">
                                    <div class="action-buttons">
                                        <button
                                                data-contract-id="{{ contract.id }}"
                                                onclick="window.location = '{% url 'contract' contract.id %}'"
                                                class="button small {% if contract.status != 'analyzed' %}hide{% endif %}"
                                        >
                                            Details anzeigen
                                        </button>
                                        <button onclick="window.location = '{% url 'edit_contract' contract.id %}'"
                                                class="small">
                                            Bearbeiten
                                        </button>
                                        <button
                                                data-contract-id="{{ contract.id }}"
                                                onclick="analyzeContract('{{ contract.id }}')"
                                                class="small"
                                                {% if contract.status == 'processing' %}disabled{% endif %}
                                        >
                                            Analyse starten
                                        </button>
                                        <button
                                                onclick="archiveContract('{{ contract.id }}')"
                                                class="small bg-error"
                                        >
                                            Archivieren
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="no-contracts">
                    <p>Sie haben noch keine Verträge hochgeladen.</p>
                    <button id="noContractsUpload" class="highlight active">Ersten Vertrag hochladen</button>
                </div>
            {% endif %}
        </section>

        {% block extra_js %}
            <script>
							// Toggle upload form visibility
							document.getElementById('showUploadForm').addEventListener('click', function () {
								const uploadSection = document.getElementById('uploadContractSection');
								uploadSection.classList.toggle('hide');
								this.textContent = uploadSection.classList.contains('hide')
									? 'Neuen Vertrag hochladen'
									: 'Upload ausblenden';
							});

							// Handle "Upload first contract" button if no contracts exist
							const noContractsUpload = document.getElementById('noContractsUpload');
							if (noContractsUpload) {
								noContractsUpload.addEventListener('click', function () {
									const uploadSection = document.getElementById('uploadContractSection');
									uploadSection.classList.remove('hide');
									document.getElementById('showUploadForm').textContent = 'Upload ausblenden';
								});
							}

							// Enhanced search functionality
							document.getElementById('contractSearch').addEventListener('input', function (e) {
								const searchText = e.target.value.toLowerCase()
								const rows = document.querySelectorAll('.contracts-table tbody tr')

								rows.forEach((row) => {
									const text = row.textContent.toLowerCase()
									row.style.display = text.includes(searchText) ? '' : 'none'
								})
							})

							function updateStatus(id, status) {
								const row = document.querySelector(`tr[data-contract-id="${id}"]`)
								const button = row.querySelector(`button[data-contract-id="${id}"]`)
								const link = row.querySelector(`a[data-contract-id="${id}"]`)

								if (row) {
									const statusCell = row.querySelector('.status-badge')
									if (statusCell) {
										statusCell.textContent = status
										statusCell.className = `status-badge
                                      ${status === 'analyzed' ? 'status-success'
											: status === 'pending' ? 'status-warning'
												: 'status-default'}`
									}
								}

								if (button) {
									button.disabled = status === 'processing'
								}

								if (link) {
									link.classList.toggle('hide', status !== 'analyzed')
								}
							}

							function analyzeContract(id) {
								// Send a request to start the analysis
								// Disable the button to prevent multiple clicks
								const button = document.querySelector(`button[data-contract-id="${id}"]`)
								if (button) {
									button.disabled = true
								}
								updateStatus(id, 'processing')

								fetch(`/contracts/${id}/analyze`, {
									method: 'POST',
									headers: {
										'X-CSRFToken': '{{ csrf_token }}'
									}
								})
							}

							function archiveContract(id) {
								if (confirm('Sind Sie sicher, dass Sie diesen Vertrag archivieren möchten?')) {
									fetch(`/contracts/${id}/archive`, {
										method: 'POST',
										headers: {
											'X-CSRFToken': '{{ csrf_token }}'
										}
									}).then(() => {
										const row = document.querySelector(`tr[data-contract-id="${id}"]`)
										if (row) {
											row.remove()
										}
									})
								}
							}

							// Handle SSE
							const contractIds = [{% for contract in contracts %}"{{ contract.id }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
							for (const id of contractIds) {
								const source = new EventSource(`/contracts/${id}/analyze/update`);

								source.onmessage = function (event) {
									updateStatus(id, event.data);
								};

								source.onerror = function (error) {
									console.error("SSE connection error:", error);
									source.close(); // Close the connection on error
								};
							}
            </script>
        {% endblock %}
    {% endif %}
{% endblock %}

{% block extra_css %}
    <style>
        /* Dashboard Layout */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .user-greeting {
            flex: 1;
        }

        .user-greeting h2 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        .user-greeting p {
            margin-top: 0;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
        }

        /* Login Section */
        .login-section {
            text-align: center;
            padding: 3rem 1rem;
        }

        .login-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .login-container h2 {
            margin-bottom: 1rem;
        }

        .login-container p {
            margin-bottom: 2rem;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-header h3 {
            margin: 0;
        }

        /* Table Styles */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            margin-top: 1rem;
            border-radius: 4px;
            box-shadow: 0 1px 3px var(--section-shadow);
        }

        .contracts-table {
            width: 100%;
            border-collapse: collapse;
        }

        .contracts-table th {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid var(--primary);
            background-color: var(--section-bg);
            position: sticky;
            top: 0;
        }

        .contracts-table td {
            padding: 16px;
            border-bottom: 1px solid var(--section-shadow);
            vertical-align: middle;
        }

        .contracts-table tr:hover {
            background-color: var(--section-shadow);
        }

        /* Document thumbnails */
        .documents-cell {
            max-width: 300px;
        }

        .documents-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0;
        }

        .thumbnail-item {
            position: relative;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            min-width: 80px;
            max-width: 100px;
        }

        .thumbnail-item.active {
            border-color: var(--primary);
        }

        .thumbnail-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .thumbnail-status {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7rem;
            padding: 2px 4px;
            text-align: center;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-success {
            background-color: #e7f5e7;
            color: #2c7f2e;
        }

        .status-warning {
            background-color: #fff4e6;
            color: #d46b08;
        }

        .status-default {
            background-color: #f5f5f5;
            color: #666;
        }

        /* Action buttons */
        .action-column {
            min-width: 150px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Search controls */
        .table-controls {
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--section-shadow);
            border-radius: 4px;
            font-size: 0.9rem;
            background-color: var(--section-bg);
            color: var(--text);
        }

        /* Empty state */
        .no-contracts {
            text-align: center;
            padding: 3rem 1rem;
        }

        .no-contracts p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        /* Upload section */
        .upload-section {
            margin-bottom: 2rem;
            border: 2px dashed var(--primary);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .dashboard-header,
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .table-controls {
                max-width: 100%;
                width: 100%;
            }

            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }
    </style>
{% endblock %}
