{% extends 'base.html' %}

{% block title %}
    Darf Vermieter Das? - Mietverträge
{% endblock %}

{% block content %}
    {% if not user.is_authenticated %}
        <section class="login-section">
            <div class="login-container">
                <h2>Willkommen bei Darf Vermieter Das?</h2>
                <p>Bitte melden Sie sich an, um Ihre Mietverträge zu analysieren und zu verwalten.</p>
                <a href="{% url 'login' %}" class="button highlight active larger">Anmelden</a>
            </div>
        </section>
    {% else %}
        <!-- Dashboard Header -->
        <section class="dashboard-header">
            <div class="user-greeting">
                <h2>Willkommen zurück, {{ user.username }}!</h2>
                <p>Hier können Sie Ihre Mietverträge hochladen, analysieren und verwalten.</p>
            </div>
            <div class="quick-actions">
                <button id="showUploadForm" class="highlight active">Neuen Vertrag hochladen</button>
            </div>
        </section>

        <!-- Upload Contract Section (Initially Hidden) -->
        <section id="uploadContractSection" class="upload-section hide">
            {% include 'contract/upload.html' %}
        </section>

        <!-- Contracts Management Section -->
        <section class="contracts-section">
            <div class="section-header">
                <h3>Meine Mietverträge</h3>

                <!-- Search and Filter -->
                <div class="table-controls">
                    <input
                            type="text"
                            id="contractSearch"
                            placeholder="Verträge durchsuchen..."
                            class="search-input"
                    >
                </div>
            </div>

            <!-- Contracts Table -->
            {% if contracts %}
                <div class="table-responsive">
                    <table class="contracts-table">
                        <thead>
                        <tr>
                            <th>Vertrag</th>
                            <th>Dokumente</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for contract in contracts %}
                            <tr data-contract-id="{{ contract.id }}">
                                <td>
                                    <strong>Mietvertrag {{ forloop.counter }}</strong>
                                    <p class="text-small">{{ contract.uploaded_at|date:"d.m.Y" }}</p>
                                </td>
                                <td class="documents-cell">
                                    <div class="documents-container">
                                        {% for file in contract.files.all %}
                                            <div class="thumbnail-item" data-file-id="{{ file.id }}">
                                                <img src="{% url 'contract_file' contract.id file.id %}"
                                                     alt="Vertragsseite {{ forloop.counter }}">
                                            </div>
                                        {% empty %}
                                            <p>Keine Vertragsdateien gefunden. Bitte laden Sie zuerst Dateien hoch.</p>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge
                                      {% if contract.status == 'analyzed' %}status-success
                                      {% elif contract.status == 'pending' %}status-warning
                                      {% else %}status-default{% endif %}">
                                      {{ contract.status }}
                                    </span>
                                </td>
                                <td class="action-column">
                                    <div class="action-buttons">
                                        <button
                                                data-contract-id="{{ contract.id }}"
                                                onclick="window.location = '{% url 'contract' contract.id %}'"
                                                class="button small {% if contract.status != 'analyzed' %}hide{% endif %}"
                                                {% if contract.status == 'processing' %}disabled{% endif %}>
                                            Anzeigen
                                        </button>
                                        <button onclick="window.location = '{% url 'edit_contract' contract.id %}'"
                                                class="small"
                                                {% if contract.status == 'processing' %}disabled{% endif %}>
                                            Zensieren
                                        </button>
                                        <button
                                                data-contract-id="{{ contract.id }}"
                                                onclick="analyzeContract('{{ contract.id }}')"
                                                class="small {% if contract.status == 'analyzed' %}bg-warning{% endif %}"
                                                {% if contract.status == 'processing' %}disabled{% endif %}
                                        >
                                            Analyse starten
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="no-contracts">
                    <p>Sie haben noch keine Verträge hochgeladen.</p>
                    <button id="noContractsUpload" class="highlight active">Ersten Vertrag hochladen</button>
                </div>
            {% endif %}
        </section>

        {% block extra_js %}
            <script>
							// Toggle upload form visibility
							document.getElementById('showUploadForm').addEventListener('click', function () {
								const uploadSection = document.getElementById('uploadContractSection');
								uploadSection.classList.toggle('hide');
								this.textContent = uploadSection.classList.contains('hide')
									? 'Neuen Vertrag hochladen'
									: 'Upload ausblenden';
							});

							// Handle "Upload first contract" button if no contracts exist
							const noContractsUpload = document.getElementById('noContractsUpload');
							if (noContractsUpload) {
								noContractsUpload.addEventListener('click', function () {
									const uploadSection = document.getElementById('uploadContractSection');
									uploadSection.classList.remove('hide');
									document.getElementById('showUploadForm').textContent = 'Upload ausblenden';
								});
							}

							// Enhanced search functionality
							document.getElementById('contractSearch').addEventListener('input', function (e) {
								const searchText = e.target.value.toLowerCase()
								const rows = document.querySelectorAll('.contracts-table tbody tr')

								rows.forEach((row) => {
									const text = row.textContent.toLowerCase()
									row.style.display = text.includes(searchText) ? '' : 'none'
								})
							})

							function updateStatus(id, status) {
								const row = document.querySelector(`tr[data-contract-id="${id}"]`)
								const button = row.querySelector(`button[data-contract-id="${id}"]`)
								const link = row.querySelector(`a[data-contract-id="${id}"]`)

								if (row) {
									const statusCell = row.querySelector('.status-badge')
									if (statusCell) {
										statusCell.textContent = status
										statusCell.className = `status-badge
                                      ${status === 'analyzed' ? 'status-success'
											: status === 'pending' ? 'status-warning'
												: 'status-default'}`
									}
								}

								if (button) {
									button.disabled = status === 'processing'
								}

								if (link) {
									link.classList.toggle('hide', status !== 'analyzed')
								}
							}

							function analyzeContract(id) {
								// Send a request to start the analysis
								// Disable the button to prevent multiple clicks
								const button = document.querySelector(`button[data-contract-id="${id}"]`)
								if (button) {
									button.disabled = true
								}
								updateStatus(id, 'processing')

								fetch(`/contracts/${id}/analyze`, {
									method: 'POST',
									headers: {
										'X-CSRFToken': '{{ csrf_token }}'
									}
								})
							}

							function archiveContract(id) {
								if (confirm('Sind Sie sicher, dass Sie diesen Vertrag archivieren möchten?')) {
									fetch(`/contracts/${id}/archive`, {
										method: 'POST',
										headers: {
											'X-CSRFToken': '{{ csrf_token }}'
										}
									}).then(() => {
										const row = document.querySelector(`tr[data-contract-id="${id}"]`)
										if (row) {
											row.remove()
										}
									})
								}
							}
            </script>
        {% endblock %}
    {% endif %}
{% endblock %}
